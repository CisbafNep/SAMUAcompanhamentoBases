<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./iconx.png" type="image/png">
    <link rel="stylesheet" href="presenBases4.css">
    <title>Controle presen√ßa Bases SAMU</title>
</head>
<body>
<header>
    <img src="/iconx.png" id="logox" width="150px">
    <button id="menu-toggle" style="width: 40px; height: 40px; font-size: 25px; background: none; border: none;">‚ò∞</button>
    <a href="/index.html">VOLTAR AO MENU</a>
    <a href="nilopBase.html">NIL√ìPOLIS</a>
    <a href="/paracBase.html">PARACAMBI</a>
    <a href="#">QUEIMADOS</a>
    <button style="width: 40px; height: 40px; font-size: 25px;border: none; background: none;" onclick="toggleMode()" id="lampa">üí°</button>
</header><br>
<nav id="sidebar" class="sidebar">
    <a href="/index.html">VOLTAR AO MENU</a>
    <a href="nilopBase.html">NIL√ìPOLIS</a>
    <a href="/paracBase.html">PARACAMBI</a>
    <a href="#">QUEIMADOS</a>
    <button style="width: 40px; height: 40px; font-size: 25px;border: none; background: none;" onclick="toggleMode()">üí°</button>
</nav>

<main>
    <div id="contentQueimados" class="content active">
        <details style="text-align: right;">
            <summary><h3 >Legendas: (clique para abrir)</h3></summary>
            <div style="text-align: right;">
                <p><span style="color: green; font: bold;">Presen√ßa</span>: Adiciona presen√ßa do colaborador na tabela.</p>
                <p><span style="color: red">Falta</span>: Adiciona falta do colaborador na tabela.</p>
                <p><span style="text-decoration: underline;">Limpar</span>: Limpa status do colaborador na tabela.</p>
                <p><span style="text-decoration: underline">Remover</span>: Remove o colaborador na tabela.</p>
                <p><span style="color: orange">A√ß√£o</span>: Executa a op√ß√£o escolhida na caixa(limpar ou remover).</p>
            </div>
        </details>
        <p style="text-align: center;"><img src="/Samu-logo.png" style="width: 120px;" alt=""></p>
        <h1 style="text-align: center;">Acompanhamento de presen√ßas base SAMU Queimados</h1><br>
        <h2 style="text-align: center; text-decoration: underline">Controle de presen√ßas</h2><br><br>
        <div id="controls" class="controls">
            <label>Colaborador:</label>
            <input type="text" id="nomeQueimados" placeholder="Digite o nome...">
            <label>Cargo:</label>
            <select id="cargoQueimados">
                <option value="M√©dico(a)">M√©dico(a)</option>
                <option value="Enfermeiro(a)">Enfermeiro(a)</option>
                <option value="Condutor">Condutor</option>
                <option value="T√©c. Enfermagem">T√©c. Enfermagem</option>
            </select>
            <button class="btnzin" onclick="adicionarParticipanteQueimados()">Adicionar participante</button>
            <button class="btnzin" onclick="gerarGraficoQueimados()">Gerar Gr√°fico</button>
        </div><br>
        <table id="tabela-presenca-queimados">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Cargo</th>
                    <th>Presen√ßa</th>
                    <th>Faltas</th>
                    <th>Presen√ßa %</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                <!--presentes add aqui-->
            </tbody>
        </table><br>
        <div id="chart-container-queimados">
            <canvas id="presenca-chart-queimados"></canvas>
        </div>
    </div>
    <div>
        <button style="width: 150px; background: rgb(5, 124, 124);"><a href="/RtsQueimados.html" style="text-decoration: none; color: #fff;">Checar relat√≥rios RTs</a></button>
    </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="presenBases4.js"></script>

<!-- Adicionando a biblioteca do QR Code -->
<script src="html5-qrcode.min.js"></script>

<script>
    let participantesQueimados = JSON.parse(localStorage.getItem('participantesQueimados')) || [];
    let codigoQRCodeLido = '';

    function salvarDadosQueimados() {
        localStorage.setItem('participantesQueimados', JSON.stringify(participantesQueimados));
    }

    function adicionarParticipanteQueimados() {
        const nome = document.getElementById('nomeQueimados').value;
        const cargo = document.getElementById('cargoQueimados').value;

        if (nome && cargo) {
            const participante = {
                nome,
                cargo,
                presenca: 0,
                faltas: 0
            };

            participantesQueimados.push(participante);
            atualizarTabelaQueimados();
            salvarDadosQueimados();
            limparcamposQueimados();
        } else {
            alert('Por favor, preencha todos os campos!')
        }
    }

    function limparcamposQueimados() {
        document.getElementById('nomeQueimados').value = '';
        document.getElementById('cargoQueimados').value = '';
    }

    function marcarPresencaQueimados(index) {
        participantesQueimados[index].presenca += 1;
        atualizarTabelaQueimados();
        salvarDadosQueimados();
    }

    function marcarFaltaQueimados(index) {
        participantesQueimados[index].faltas += 1;
        atualizarTabelaQueimados();
        salvarDadosQueimados();
    }

    function limparPresencaFaltaQueimados(index) {
        participantesQueimados[index].presenca = 0;
        participantesQueimados[index].faltas = 0;
        atualizarTabelaQueimados();
        salvarDadosQueimados();
    }

    function removerParticipanteQueimados(index) {
        participantesQueimados.splice(index, 1);
        atualizarTabelaQueimados();
        salvarDadosQueimados();
    }

    function atualizarTabelaQueimados() {
        const totalAulas = 9; // Total de aulas
        const tabela = document.getElementById('tabela-presenca-queimados').getElementsByTagName('tbody')[0];
        tabela.innerHTML = '';

        participantesQueimados.forEach((participante, index) => {
            const row = tabela.insertRow();

            const porcentagemPresenca = ((participante.presenca / totalAulas) * 100).toFixed(0) + '%';

            row.insertCell(0).innerHTML = participante.nome;
            row.insertCell(1).innerHTML = participante.cargo;
            row.insertCell(2).innerHTML = participante.presenca;
            row.insertCell(3).innerHTML = participante.faltas;
            row.insertCell(4).innerHTML = porcentagemPresenca; // Nova coluna para porcentagem de presen√ßa

            const actionsCell = row.insertCell(5);
            actionsCell.innerHTML = `
                <button onclick="marcarPresencaQueimados(${index})" style="background: green;">Presen√ßa</button>
                <button onclick="marcarFaltaQueimados(${index})" style="background: red; color: #fff;">Falta</button>
                
                <select id="acaoSelect${index}">
                    <option value="#">Escolha...</option>
                    <option value="limparPresencaFaltaQueimados">Limpar</option>
                    <option value="removerParticipanteQueimados">Remover</option>
                </select>
                <button onclick="executarAcao(${index})" style="background: orange; color: #333;">A√ß√£o</button>
            `;
        });

        atualizarGraficoQueimados();
    }

    function executarAcao(index) {
        const select = document.getElementById(`acaoSelect${index}`);
        const acao = select.value;

        if (acao === 'limparPresencaFaltaQueimados') {
            limparPresencaFaltaQueimados(index);
        } else if (acao === 'removerParticipanteQueimados') {
            removerParticipanteQueimados(index);
        }
    }

    function atualizarGraficoQueimados() {
        const ctx = document.getElementById('presenca-chart-queimados').getContext('2d');
        const presencas = participantesQueimados.map(participante => participante.presenca);
        const nomes = participantesQueimados.map(participante => participante.nome);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: nomes,
                datasets: [{
                    label: 'Presen√ßa',
                    data: presencas,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Fun√ß√µes do QR Code
    function onScanSuccess(decodedText) {
        codigoQRCodeLido = decodedText; // Armazena o c√≥digo lido
        alert(`QR Code lido: ${codigoQRCodeLido}`);
        adicionarPresenca(); // Adiciona presen√ßa assim que o QR Code for lido
    }

    function onScanError(errorMessage) {
        // L√≥gica de erro, se necess√°rio
    }

    function iniciarLeituraQRCode() {
        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            },
            onScanSuccess,
            onScanError
        ).catch(err => {
            console.error(`Erro ao iniciar a leitura do QR Code: ${err}`);
        });
    }

    function adicionarPresenca() {
        const participanteIndex = participantesQueimados.findIndex(participante => participante.nome === codigoQRCodeLido);

        if (participanteIndex !== -1) {
            marcarPresencaQueimados(participanteIndex);
            alert(`Presen√ßa registrada para: ${codigoQRCodeLido}`);
        } else {
            alert(`Colaborador n√£o encontrado: ${codigoQRCodeLido}`);
        }
    }

    // Inicia a leitura do QR Code quando a p√°gina √© carregada
    window.onload = function () {
        iniciarLeituraQRCode();
    };

</script>
</body>
</html>
